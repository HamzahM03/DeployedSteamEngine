<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Game Recommender</title>

  <!-- served by FastAPI /static -->
  <link rel="icon" type="image/png" href="/static/Steam_Engine.png" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: "Inter", sans-serif;
      background-color: #f8f9fa;
    }
    #autocomplete-results {
      max-height: 20rem;
      overflow-y: auto;
    }
    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4f46e5;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: none;
    }
    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;

    }
        :root {
      --steam-bg-dark: #0b1020;
      --steam-bg-dark2: #171a21;
      --steam-card-dark: #1b2838;
      --steam-card-border: #2a475e;
      --steam-accent: #66c0f4;
      --steam-accent-soft: #2a475e;
    }

    body.theme-light {
      background-color: #f8f9fa;
      color: #111827;
    }

    body.theme-dark {
      background:
        radial-gradient(circle at top, #1b2838 0, #0b1020 50%, #020617 100%);
      color: #e5e7eb;
    }

    body.theme-dark header {
      background-color: var(--steam-bg-dark2);
      box-shadow: none;
      border-bottom: 1px solid #111827;
    }

    body.theme-dark .brand-text {
      color: var(--steam-accent);
    }

    body.theme-dark #game-input {
      background-color: var(--steam-card-dark);
      border-color: var(--steam-card-border);
      color: #e5e7eb;
    }

    body.theme-dark #game-input::placeholder {
      color: #9ca3af;
    }

    body.theme-dark .card {
      background-color: var(--steam-card-dark);
      border-color: var(--steam-card-border);
    }

    body.theme-dark .price-filter-box {
      background-color: var(--steam-card-dark);
      border-color: var(--steam-card-border);
    }

    body.theme-dark .price-filter-box label {
      background-color: #111827;
      border-color: #374151;
      color: #e5e7eb;
    }

    body.theme-dark .price-filter-box input:checked + span {
      color: var(--steam-accent);
    }

    body.theme-dark a {
      color: var(--steam-accent);
    }

    body.theme-dark a:hover {
      color: #9cd9ff;
    }

  </style>
</head>
  <body class="text-gray-900 theme-light">

  <header class="bg-white shadow-md sticky top-0 z-30">
    <nav
      class="container mx-auto px-6 py-4 flex justify-between items-center"
    >
            <a
        href="#"
        id="logo-link"
        class="flex items-center gap-3 text-2xl font-bold brand-text hover:opacity-90 transition"
      >

        <img
          src="/static/Steam_Engine.png"
          alt="Logo"
          class="h-10 w-10 object-contain"
        />
        <span>Steam Engine</span>
      </a>

            <div class="flex items-center gap-4">
        <!-- Home as a BUTTON so JS fully controls it -->
        <button
          id="home-link"
          type="button"
          class="text-gray-600 hover:text-indigo-600 dark:text-gray-300 text-sm font-medium"
        >
          Home
        </button>

        <!-- üåô / ‚òÄÔ∏è theme toggle -->
        <button
          id="theme-toggle"
          class="flex items-center gap-2 text-sm px-3 py-1.5 rounded-full border border-gray-300 hover:border-indigo-500 hover:text-indigo-600 transition bg-white/80 backdrop-blur-sm"
          type="button"
        >
          üåô <span>Dark Mode</span>
        </button>
      </div>



    
    </nav>
  </header>

  <main class="min-h-screen flex flex-col items-center pt-20 px-4 pb-20">
    <div class="text-center mb-10">
      <h1 class="text-4xl font-bold text-gray-900 mb-4">
        Find Your Next Adventure
      </h1>
      <p class="text-lg text-gray-600">
        Give me a game and I'll surprise you.
      </p>
      <div
        id="connection-status"
        class="hidden mt-2 inline-block bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full font-semibold"
      >
        ‚ö†Ô∏è Offline Mode
      </div>
    </div>

    <!-- SEARCH & FILTER SECTION -->
    <div class="w-full max-w-xl relative z-20 space-y-4">
      <!-- Price filters -->
        <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm price-filter-box">

        <label class="text-sm font-bold text-gray-700 block mb-3">
          Price Filter (Select One)
        </label>
        <div class="flex flex-wrap gap-3">
          <label
            class="inline-flex items-center space-x-2 cursor-pointer bg-gray-50 px-3 py-2 rounded-lg border border-gray-200 hover:bg-gray-100 transition"
          >
            <input
              type="radio"
              name="price_filter"
              value="any"
              checked
              class="form-radio h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300"
            />
            <span class="text-sm text-gray-700">Any Price</span>
          </label>

          <label
            class="inline-flex items-center space-x-2 cursor-pointer bg-gray-50 px-3 py-2 rounded-lg border border-gray-200 hover:bg-gray-100 transition"
          >
            <input
              type="radio"
              name="price_filter"
              value="free"
              class="form-radio h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300"
            />
            <span class="text-sm text-gray-700">Free</span>
          </label>

          <label
            class="inline-flex items-center space-x-2 cursor-pointer bg-gray-50 px-3 py-2 rounded-lg border border-gray-200 hover:bg-gray-100 transition"
          >
            <input
              type="radio"
              name="price_filter"
              value="under_5"
              class="form-radio h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300"
            />
            <span class="text-sm text-gray-700">Below $5</span>
          </label>

          <label
            class="inline-flex items-center space-x-2 cursor-pointer bg-gray-50 px-3 py-2 rounded-lg border border-gray-200 hover:bg-gray-100 transition"
          >
            <input
              type="radio"
              name="price_filter"
              value="under_10"
              class="form-radio h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300"
            />
            <span class="text-sm text-gray-700">Below $10</span>
          </label>

          <label
            class="inline-flex items-center space-x-2 cursor-pointer bg-gray-50 px-3 py-2 rounded-lg border border-gray-200 hover:bg-gray-100 transition"
          >
            <input
              type="radio"
              name="price_filter"
              value="under_30"
              class="form-radio h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300"
            />
            <span class="text-sm text-gray-700">Below $30</span>
          </label>

          <label
            class="inline-flex items-center space-x-2 cursor-pointer bg-gray-50 px-3 py-2 rounded-lg border border-gray-200 hover:bg-gray-100 transition"
          >
            <input
              type="radio"
              name="price_filter"
              value="under_50"
              class="form-radio h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300"
            />
            <span class="text-sm text-gray-700">Below $50</span>
          </label>

          <label
            class="inline-flex items-center space-x-2 cursor-pointer bg-gray-50 px-3 py-2 rounded-lg border border-gray-200 hover:bg-gray-100 transition"
          >
            <input
              type="radio"
              name="price_filter"
              value="above_50"
              class="form-radio h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300"
            />
            <span class="text-sm text-gray-700">$50+</span>
          </label>
        </div>
      </div>

      <!-- Search bar -->
      <div class="relative">
        <input
          type="text"
          id="game-input"
          placeholder="e.g. Resident Evil..."
          class="w-full px-6 py-4 text-lg border-2 border-gray-200 bg-white rounded-full shadow-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-300 pr-12"
        />
        <div
          id="spinner"
          class="loader absolute right-6 top-1/2 transform -translate-y-1/2"
        ></div>
      </div>

      <div
        id="autocomplete-results"
        class="hidden absolute top-full mt-2 w-full bg-white border border-gray-100 rounded-xl shadow-2xl overflow-hidden"
      ></div>
    </div>

    <!-- RESULTS -->
    <div
      id="recommendation-section"
      class="w-full max-w-6xl mt-16 hidden"
    >
      <h2
        class="text-2xl font-bold mb-8 text-gray-800 border-l-4 border-indigo-600 pl-4"
      >
        Because you liked <span id="selected-game-name" class="text-indigo-600">...</span>
      </h2>

      <div
        id="cards-container"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
      ></div>
    </div>
  </main>

  <script>
    const gameInput = document.getElementById("game-input");
    const resultsContainer = document.getElementById("autocomplete-results");
    const spinner = document.getElementById("spinner");
    const recSection = document.getElementById("recommendation-section");
    const cardsContainer = document.getElementById("cards-container");
    const selectedGameLabel = document.getElementById("selected-game-name");
    const statusBadge = document.getElementById("connection-status");

    let debounceTimer;

    // fallback sample data
    const mockDatabase = [
      {
        name: "Elden Ring",
        genres: "Action, RPG",
        price: "59.99",
        app_id: 1245620,
        header_image:
          "https://cdn.akamai.steamstatic.com/steam/apps/1245620/header.jpg",
        about_the_game: "Rise, Tarnished, and be guided by grace.",
      },
      {
        name: "Portal 2",
        genres: "Action, Adventure",
        price: "9.99",
        app_id: 620,
        header_image:
          "https://cdn.akamai.steamstatic.com/steam/apps/620/header.jpg",
        about_the_game: "Design co-op puzzles for you and your friends!",
      },
      {
        name: "The Witcher 3: Wild Hunt",
        genres: "RPG",
        price: "39.99",
        app_id: 292030,
        header_image:
          "https://cdn.akamai.steamstatic.com/steam/apps/292030/header.jpg",
        about_the_game: "Track down the Child of Prophecy.",
      },
    ];

    gameInput.addEventListener("input", () => {
      const query = gameInput.value.trim();
      clearTimeout(debounceTimer);

      if (!query.length) {
        resultsContainer.classList.add("hidden");
        return;
      }

      debounceTimer = setTimeout(() => {
        fetchSearchMatches(query);
      }, 300);
    });

    gameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        const query = gameInput.value.trim();
        if (query.length > 0) {
          resultsContainer.classList.add("hidden");
          getRecommendations(query);
        }
      }
    });

    async function fetchSearchMatches(query) {
      try {
        spinner.style.display = "block";
        const response = await fetch(
          `/games?limit=6&search=${encodeURIComponent(query)}`
        );
        if (!response.ok) throw new Error("API error");
        const games = await response.json();
        statusBadge.classList.add("hidden");
        displayDropdown(games);
      } catch (err) {
        statusBadge.classList.remove("hidden");
        const mockResults = mockDatabase.filter((g) =>
          g.name.toLowerCase().includes(query.toLowerCase())
        );
        displayDropdown(mockResults);
      } finally {
        spinner.style.display = "none";
      }
    }

    function displayDropdown(games) {
      resultsContainer.innerHTML = "";
      if (!games.length) {
        resultsContainer.classList.add("hidden");
        return;
      }

      games.forEach((game) => {
        const item = document.createElement("div");
        item.className =
          "px-6 py-4 hover:bg-indigo-50 cursor-pointer border-b last:border-none border-gray-100 flex items-center";
        item.innerHTML = `<span class="font-medium text-gray-700">${game.name}</span>`;
        item.addEventListener("click", () => {
          gameInput.value = game.name;
          resultsContainer.classList.add("hidden");
          getRecommendations(game.name);
        });
        resultsContainer.appendChild(item);
      });
      resultsContainer.classList.remove("hidden");
    }

    async function getRecommendations(gameName) {
      recSection.classList.remove("hidden");
      selectedGameLabel.textContent = `"${gameName}"`;
      cardsContainer.innerHTML =
        '<div class="col-span-full text-center py-10 text-gray-500">Finding best match and generating recommendations...</div>';

      try {
        const url = new URL("/recommend", window.location.origin);
        url.searchParams.append("game_name", gameName);

        const selectedRadio = document.querySelector(
          'input[name="price_filter"]:checked'
        );
        if (selectedRadio) {
          url.searchParams.append("price_filter", selectedRadio.value);
        }

        const response = await fetch(url);
        if (response.status === 404) {
          cardsContainer.innerHTML =
            '<div class="col-span-full text-center text-red-500 font-bold">No game found matching that name. Try being more specific.</div>';
          return;
        }
        if (!response.ok) throw new Error("Failed");

        const data = await response.json();

        console.log("API returned:", data);
        console.log("Each recommendation:", data.recommendations);


        selectedGameLabel.textContent = data.source_game;
        renderCards(data.recommendations);
      } catch (err) {
        console.warn("Rec error:", err);
        renderCards(mockDatabase);
      }
    }

    // Turn a 0‚Äì100% rating into a 5-star string like ‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ
    function renderStarsFromPct(pct) {
      const rating = pct / 20; // converts 0-100% to 0-5 scale
      const full = Math.floor(rating);
      const half = rating % 1 >= 0.5 ? 1 : 0;
      const empty = 5 - full - half;

      return "‚òÖ".repeat(full) + (half ? "¬Ω" : "") + "‚òÜ".repeat(empty);
  }



    function renderCards(games) {
  cardsContainer.innerHTML = "";

  if (!games || !games.length) {
    cardsContainer.innerHTML =
      '<div class="col-span-full text-center text-gray-500">No games found with the selected filters.</div>';
    return;
  }

  games.forEach((game) => {
    const card = document.createElement("div");
    card.className =
      "card bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition duration-300 flex flex-col h-full border border-gray-100 group";


    const cleanDesc = game.about_the_game
      ? game.about_the_game.replace(/<[^>]*>?/gm, "")
      : "No description available.";

    const imageSrc =
      game.header_image || "https://placehold.co/600x400?text=No+Image";

    // üî• new: fall back to Steam search using the game name
    const steamUrl = game.app_id
      ? `https://store.steampowered.com/app/${game.app_id}`
      : `https://store.steampowered.com/search/?term=${encodeURIComponent(
          game.name || ""
        )}`;

    const linkTarget = game.app_id ? "_blank" : "_blank";

    let reviewsHtml = "";
    if (game.pct_pos_total != null && game.num_reviews_total != null) {
      const pct = Math.round(Number(game.pct_pos_total));
      const count = Number(game.num_reviews_total).toLocaleString();
      const stars = renderStarsFromPct(pct);
      reviewsHtml = `
        <div class="mt-2 text-xs text-gray-500 flex items-center gap-2">
          <span class="text-yellow-500">${stars}</span>
          <span>${pct}% positive (${count} reviews)</span>
        </div>
      `;
    }

        card.innerHTML = `
      <a href="${steamUrl}" target="${linkTarget}" class="block relative overflow-hidden">
        <img src="${imageSrc}" alt="${game.name}" class="w-full h-48 object-cover transform group-hover:scale-105 transition duration-500">
        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition duration-300"></div>
      </a>
      <div class="p-6 flex-grow flex flex-col">
        <div class="mb-4">
          <h3 class="text-xl font-bold text-gray-900 mb-2 group-hover:text-indigo-600 transition">
            <a href="${steamUrl}" target="${linkTarget}">${game.name}</a>
          </h3>

          <span class="inline-block bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded-full font-semibold">
            ${game.genres || "Game"}
          </span>

          ${reviewsHtml} <!-- ‚≠ê Now displays rating if data exists -->
        </div>

        <p class="text-gray-600 text-sm line-clamp-3 mb-4 flex-grow">
          ${cleanDesc}
        </p>

        <div class="pt-4 border-t border-gray-100 flex justify-between items-center">
          <span class="text-gray-900 font-bold">$${game.price || "0.00"}</span>
          <a href="${steamUrl}" target="${linkTarget}" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium flex items-center gap-1">
            View on Steam
          </a>
        </div>
      </div>
    `;
    cardsContainer.appendChild(card);
  });
}



    document.addEventListener("click", (e) => {
      if (
        !gameInput.contains(e.target) &&
        !resultsContainer.contains(e.target)
      ) {
        resultsContainer.classList.add("hidden");
      }
    });
        // THEME TOGGLE (light / dark)
          // THEME TOGGLE (light / dark)
    const themeToggle = document.getElementById("theme-toggle");
    const bodyEl = document.body;

    function setTheme(theme) {
      bodyEl.classList.remove("theme-light", "theme-dark");
      if (theme === "dark") {
        bodyEl.classList.add("theme-dark");
        if (themeToggle) {
          themeToggle.innerHTML = '‚òÄÔ∏è <span>Light Mode</span>';
        }
      } else {
        bodyEl.classList.add("theme-light");
        if (themeToggle) {
          themeToggle.innerHTML = 'üåô <span>Dark Mode</span>';
        }
      }
      try {
        localStorage.setItem("theme", theme);
      } catch (e) {
        // ignore if localStorage blocked
      }
    }

    // load saved theme if available
    let savedTheme = "light";
    try {
      const stored = localStorage.getItem("theme");
      if (stored === "light" || stored === "dark") {
        savedTheme = stored;
      }
    } catch (e) {}
    setTheme(savedTheme);

    if (themeToggle) {
      themeToggle.addEventListener("click", () => {
        const newTheme = bodyEl.classList.contains("theme-dark")
          ? "light"
          : "dark";
        setTheme(newTheme);
      });
    }

    // HOME / LOGO reset UI to default
    const homeLink = document.getElementById("home-link");
    const logoLink = document.getElementById("logo-link"); // only works if you added that id

    function resetUI() {
      gameInput.value = "";
      resultsContainer.classList.add("hidden");
      recSection.classList.add("hidden");
      cardsContainer.innerHTML = "";
      selectedGameLabel.textContent = "...";

      const anyRadio = document.querySelector(
        'input[name="price_filter"][value="any"]'
      );
      if (anyRadio) anyRadio.checked = true;

      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    if (homeLink) {
      homeLink.addEventListener("click", resetUI);
    }

    if (logoLink) {
      logoLink.addEventListener("click", resetUI);
    }




  </script>
</body>
</html>
